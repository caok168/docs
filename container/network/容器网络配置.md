# 容器网络配置：容器网络延时要比宿主机上的高吗？

### netperf
netperf：是一个衡量网络性能的工具，它可以提供单向吞吐量和端到端延迟的测试

测试宿主机和容器中网络的延迟情况
* 在宿主机上执行
    - netperf -H 192.168.1.1 -t TCP_RR
* 在容器中执行
    - netperf -H 192.168.1.1 -t TCP_RR

容器中比宿主机上大概延迟10%

### 总结
* 容器通常缺省使用veth虚拟网络接口，不过veth接口会有比较大的网络延时。 我们可以使用netperf这个工具来比较网络延时，相比物理机上的网络延时，使用veth接口容器的网络延时会增加超过10% 。
* 通过对veth实现的代码做分析，可以看到veth接口是成对工作，在对外发送数据的时候，peer veth接口都会raise softirq来完成一次收包操作，这样就会带来数据包处理的额外开销。
* 如果要减少容器网络延时，可以给容器配置ipvlan/macvlan的网络接口来代替veth网络接口。
    - Ipvlan/macvlan直接在物理网络接口上虚拟出接口，在发送对外数据包的时候可以直接通过物理接口完成，没有节点内部类似veth的那种softirq的开销。
    - 容器使用ipvlan/macvlan的网络接口，它的网络延时可以非常接近物理网络接口的延时。
* 由于ipvlan/macvlan网络接口直接挂载在物理网络接口上，对于需要使用iptables规则的容器，比如Kubernetes里使用service的容器，就不能工作了。
