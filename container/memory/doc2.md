# 容器内存
## PageCache：为什么我的容器内存使用量总在临界点

## 知识详解：Linux系统有哪些内存类型？

### Linux内存类型
Linux的各个模块都需要内存，
* 比如内核需要分配内存给页表，内核栈，还有slab，也就是内核各种数据结构的Cache Pool;
* 用户态进程里的堆内存和栈内存，共享库的内存，还有文件读写的Page Cache。


用户态相关的两个内存类型：RSS和Page Cache。

### RSS
RSS是Resident Set Size的缩写，简单来说是指进程真正申请到物理页面的内存大小。

当进程对这块内存地址开始做真正读写操作的时候，系统才会把实际需要的物理内存分配给进程。而这个过程中，进程真正得到的物理内存，就是这个RSS了。

对于进程来说，RSS内存包含了进程的代码段内存，栈内存，堆内存，共享库的内存，这些内存是进程运行所必须的。

具体的每一部分的RSS内存的大小，可以查看 /proc/[pid]/smaps文件。

### Page Cache
每个进程除了各自独立分配到的RSS内存外，如果进程对磁盘上的文件做了读写操作，Linux还会分配内存，把磁盘上读写到的页面存放在内存中，这部分的内存就是Page Cache。

Page Cache的主要作用是提高磁盘文件的读写性能，因为系统调用read（）和write（）的缺省行为都会把读过或写过的页面存放在Page Cache里。

### Linux的内存管理机制
Linux的内存管理有一种内存页面回收机制（page frame reclaim），会根据系统里空闲物理内存是否低于某个阈值（watermark），来决定是否启动内存的回收。

内存回收的算法会根据不同类型的内存以及内存的最近最少原则，就是LRU算法来决定哪些内存页面先被释放。因为Page Cache的内存页面只是起到Cache作用，自然是会被优先释放的。

所以，Page Cache是一种为了提高磁盘文件读写性能而利用空闲物理内存的机制。同时，内存管理中的页面回收机制，又能保证Cache所占用的页面可以及时释放，这样一来就不会影响对内存的真正需求了。


**所以判断容器真实的内存使用量，我们不能用Memory Cgroup里的memory.usage_in_bytes，而需要用memory.stat里的rss值。**

