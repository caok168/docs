# Once:一个简约而不简单的并发原语

### 使用场景
* Once常常用来初始化单例资源
* 或者并发访问只需初始化一次的共享资源
* 或者在测试的时候初始化一次的测试资源

### 实现
* 一个正确的Once实现要使用一个互斥锁，这样初始化的时候如果有并发的goroutine，就会进入doSlow方法。
* 互斥锁的机制保证只有一个goroutine进行初始化，同时利用双检查的机制（double-checking），再次判断o.done是否为0，如果为0，则是第一次执行，执行完毕后，就将o.done设置为1，然后释放锁。

### 两种错误
* 死锁：解决方案：不要在f参数中调用当前的这个Once，不管是直接的还是间接的。
* 未初始化：解决方案：可以自己实现一个类似Once的并发原语，既可以返回当前调用Do方法是否正确完成，还可以在初始化失败后调用Do方法再次尝试初始化，直到初始化成功才不再初始化了。

