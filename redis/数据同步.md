# 数据同步

Redis具有高可靠性，有两层含义：
* 数据尽量少丢失 （采用AOF和RDB）
* 服务尽量少中断 （增加副本冗余量）

### 主从库间如何进行第一次同步？
* 第一阶段：主从库间建立连接、协商同步的过程，主要是为全量复制做准备。在这一步，从库和主库建立起连接，并告诉主库即将进行同步，主库确认回复后，主从库间就可以开始同步了
* 第二阶段：主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载。这个过程依赖于内存快照生成的RDB文件。
* 第三阶段：主库会把第二阶段执行过程中新收到的写命令，再发送给从库。
    - 具体操作是，当主库完成RDB文件发送后，就会把此时replication buffer中的修改操作发给从库，从库再重新执行这些操作。这样一来，主从库就实现同步了。

一点主从库完成了全量复制，它们之间就会一直维护一个网络连接，主库会通过这个连接将后续陆续收到的命令操作再同步给从库，这个过程也称为**基于长连接的命令传播**，可以避免频繁建立连接的开销。

### 主从库间网络断了怎么办？
增量复制

有一个repl_backlog_buffer这个缓冲区，当主从库连接断开后，主库会把断连期间收到的写操作命令，写入replication buffer，同时也会把这些操作命令也写入repl_backlog_buffer这个缓冲区。

* repl_backlog_buffer是一个环形缓冲区，主库会记录自己写到的位置，从库则会记录自己已经读到的位置。
* 有一个参数repl_backlog_size ,这个参数和所需的缓冲空间大小有关
* 缓冲空间大小 = 主库写入命令速度 * 操作大小 - 主从库间网络传输命令速度 * 操作大小
* repl_backlog_size = 缓冲空间大小 * 2
* 如果repl_backlog_size配置过小，在增量复制阶段，可能会导致从库的复制进度赶不上主库，进而导致从库重新进行全量复制

针对高并发的情况，连两倍的缓冲都存不下新的请求的话，此时，主从库数据仍然可能不一致。
* 可以根据Redis所在服务器的内存资源再适当增加repl_backlog_size值，比如说设置成缓冲空间大小的4倍；
* 可以考虑使用切片集群来分担单个主库的请求压力。


Redis的主从同步的基本原理，有三种模式：
* 全量复制
* 基于长连接的命令传播
* 增量复制

## 问题：
为什么主从库间的复制不使用AOF呢？
* RDB经过压缩的二进制数据，文件很小。
* 主从传输的时候尽量降低对主库机器网络带宽的消耗
* 从库在加载RDB文件时，一是文件小，读取整个文件的速度会很快，二是因为RDB文件存储的都是二进制数据，还原数据比较快
* 假设使用AOF做全量同步，意味着必须打开AOF功能，打开AOF就要选择文件刷盘策略。



