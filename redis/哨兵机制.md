# 哨兵机制：主库挂了，如何不间断服务？

## 哨兵机制的基本流程
哨兵其实就是一个运行在特殊模式下的Redis进程，主从库实例运行的同时，它也在运行。

哨兵主要负责的就三个任务：监控、选主（选择主库）和通知。

### 监控
监控是指哨兵进程在运行时，周期性地给所有的主从库发送PING命令，检测它们是否仍然在线运行。如果没有在规定的时间内响应哨兵的PING命令，哨兵就会把它标记为“下线状态”。

哨兵对主库的下线判断有“主观下线”和“客观下线”两种：
* 主观下线
    - 哨兵进程会使用PING命令检测它自己和主、从库的网络连接情况，用来判断实例的状态。如果超时了，就会标记为“主观下线”。
    - 对主库，可能会误判，需要减少误判，需要商量后，再做决定。
* 客观下线
    - 通常会采用多实例组成的集群模式进行部署，称为哨兵集群
    - 只有大多数的哨兵实例，都判断主库已经“主观下线”了，主库才会被标记为“客观下线”


### 选主
选出新主库

哨兵选择新主库的过程称为“筛选 + 打分”。
* 筛选
    - 除了要检查从库的当前在线状态，还要判断它之前的网络连接状态。
* 打分
    - 用户可以通过slave-priority配置项，给不同的从库设置不同优先级，从优先级最高的从库得分高
    - 和就主库同步程度最接近的从库得分高
    - ID号小的从库得分高


### 通知
* 让从库执行replicaof，与新主库同步
* 通知客户端，与新主库连接

 ## 问题：
如果在主从库切换过程中，客户端能否正常地进行请求操作呢？如果想要应用程序不敢知服务的中断，还需要哨兵或客户端再做些什么吗？

1、如果在主从库切换过程中，客户端能否正常地进行请求操作呢？
* 如果客户端使用了读写分离，那么读请求可以在从库上正常执行，不会受到影响。但是由于此时主库已经挂了，而且哨兵还没有选出新的主库，所以在这期间写请求会失败，失败持续时间 = 哨兵切换主从的时间 + 客户端感知到新主库的时间。

2、如果想要应用程序不敢知服务的中断，还需要哨兵或客户端再做些什么吗？
* 当哨兵完成主从切换后，客户端需要及时感知到主库发生了变更，然后把缓存的写请求写入到新库中，保证后续写请求不会再受到影响，具体做法如下：
    - 哨兵提升一个从库为新主库后，哨兵会把新主库的地址写入到自己实例的pubsub（switch-master）中。客户端需要订阅这个pubsub，当这个pubsub有数据时，客户端就能感知到主库发生变更，同时可以拿到最新的主库地址，这种机制属于哨兵主动通知客户端。
    - 如果客户端因为某些原因错过了哨兵的通知，或者哨兵通知后客户端处理失败了，安全起见，客户端也需要支持主动去获取最新主从的地址进行访问。
    - 所以，客户端需要访问主从库时，需要从哨兵集群中获取到最新的地址（sentinel get-master-addr-by-name命令），这样当实例异常时，哨兵切换后或者客户端断开重连，都可以从哨兵集群中拿到最新的实例地址。
    - 一般Redis的SDK都提供了哨兵拿到实例地址，再访问实例的方式。


## 哨兵机制

### 哨兵集群中的关键机制
* 基于pub/sub机制的哨兵集群组成过程
* 基于INFO命令的从库列表，这可以帮助哨兵和从库建立连接
* 基于哨兵自身的pub/sub功能，这实现了客户端和哨兵之间的事件通知

### 如果一个想称为Leader的哨兵，要满足两个条件：
* 拿到半数以上的赞成票
* 拿到的票数同时还需要大于等于哨兵配置文件中的quorum值



