# 数据库优化方案（一）：查询请求增加时，如何做主从分离？

## 主从读写分离
大部分系统的访问模型是读多写少，读写请求量的差距可能达到几个数量级。

### 主从读写的两个技术关键点
* 一个是数据的拷贝，我们称为主从复制；
* 在主从分离的情况下，我们如何屏蔽主从分离带来的访问数据库方式的变化，让开发同学像是使用单一数据库一样。

### 主从复制
以Mysql为例介绍：

过程如下：
* 从库在连接到主节点时会创建一个IO线程，用以请求主库更新的binlog，并且把接收到的binlog信息写入一个叫做relay log的日志文件中；
* 主库也会创建一个log dump线程来发送binlog给从库；
* 同时，从库还会创建一个SQL线程读取relay log中的内容，并且在从库中做回放，最终实现主从的一致性。

主从同步的延迟，使我们排查问题时很容易忽略的一个问题。

### 如何访问数据库

分为两类
* 以代码形式内嵌运行在应用程序内部。可以把它看成是一种数据源的代理，它的配置管理着多个数据源，每个数据源对应一个数据库，可能是主库，可能是从库。
* 单独部署的代理层方案。

## 总结
* 主从读写分离以及部署一主多从可以解决突发的数据库读流量，是一种数据库横向扩展的方法；
* 读写分离后，主从的延迟是一个关键的监控指标，可能会造成写入数据之后立刻读的时候读取不到的情况；
* 业界有很多的方案可以屏蔽主从分离之后数据库访问的细节，让开发人员像是访问单一数据库一样，包括有像TDDL、Sharding-JDBC这样的嵌入应用内部的方案，也有向Mycat这样的独立部署的代理方案。

### 使用主从复制这个技术的时候，会考虑的问题
* 主从的一致性和写入性能的权衡
* 主从的延迟问题，很多诡异的读取不到的数据问题都可能会和它有关

很多组件都会用到这个技术，比如
* Redis也是通过主从复制实现读写分离；
* Elasticsearch中存储的索引分片也可以被复制到多个节点中；
* 写入到HDFS中文件也会被复制到多个DataNode中。

只是不同的组件对于复制的一致性和延迟要求不同，采用的方案也不同。

