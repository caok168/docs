# 如何学习Linux性能优化

* 性能分析，其实就是找出应用或系统的瓶颈，并设法去避免或者缓解它们，从而更高效地利用系统资源处理更多的请求。

包含一系列的步骤：
* 选择指标评估应用程序和系统的性能
* 为应用程序和系统设置性能目标
* 进行性能基准测试
* 性能分析定位瓶颈
* 优化系统和应用程序
* 性能监控和告警

当遇到I/O性能问题时，可以使用iostat、iotop、blktrace等工具分析磁盘I/O的瓶颈。

### 平均负载
* 平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是**平均活跃进程数**。
* 不可中断状态实际上是系统对进程和硬件设备的一种保护机制。


### 平均负载与CPU使用率
* 平均负载是指在单位时间内，处于可运行状态和不可中断状态的进程数。所以，它不仅包括了正在使用CPU的进程，还包括等待CPU和等待I/O的进程。
* 而CPU使用率，是单位时间内CPU繁忙情况的统计，跟平均负载并不一定完全对应，比如：
    - CPU密集型进程，使用大量CPU会导致平均负载升高，此时这两者是一致的；
    - I/O密集型进程，等待I/O也会导致平均负载升高，但CPU使用率不一定很高；
    - 大量等待CPU的进程调度也会导致平均负载升高，此时的CPU使用率也会比较高。

使用工具
* iostat
* mpstat
    - 是一个常用的多核CPU性能分析工具，用来实时查看每个CPU的性能指标，以及所有CPU的平均指标。
* pidstat
    - 是一个常用的进程性能分析工具，用来实时查看进程的CPU、内存、I/O以及上下文切换等性能指标。

* stress是一个Linux系统压力测试工具，这里我们用作异常进程模拟平均负载升高的场景。
* sysstat包含了常用的Linux性能工具，用来监控和分析系统的性能。


### 场景一：CPU密集型进程
```
stress --cpu 1 --timeout 600
```

第二个终端：
```
# -d 参数表示高亮显示变化的区域
watch -d uptime
```

第三个终端：
```
-P ALL 表示监控所有CPU，后面数字5表示间隔5秒后输出一组数据
mpstat -P ALL 5
```

```
# 间隔5秒后输出一组数据
pidstat -u 5 1
```

### 场景二：I/O密集型进程
```
stress -i 1 --timeout 600
```

```
watch -d uptime
```

```
# 显示所有CPU的指标，并在间隔5秒输出一组数据
mpstat -P ALL 5 1
```

```
# 间隔5秒后输出一组数据， -u 表示CPU指标
pidstat -u 5 1
```

### 场景三：大量进程的场景
```
stress -c 8 --timeout 600
```

```
uptime
```

```
pidstat -u 5 1
```


